---

- name: gz folder locally and ungz on remote host
  hosts: all
  gather_facts: false

  vars:
    final_data_dir: "/mnt/zmdata/home-media-app/data/final-data"
    vector_db_dir: "/mnt/zmdata/home-media-app/data/app-data/vectordb"
    models_dir: "/mnt/zmdata/home-media-app/models"
    final_data_archive_path: "/mnt/zmdata/tmp/final-data.gz"
    vector_db_archive_path: "/mnt/zmdata/tmp/vector_db.gz"
    models_archive_path: "/mnt/zmdata/tmp/models.gz"
    remote_dest_dir: "/tmp/zmdata"

  tasks:
    - name: Create a gz archive of the final data local folder
      community.general.archive:
        path: "{{ final_data_dir }}"
        dest: "{{ final_data_archive_path }}"
        format: gz
      delegate_to: localhost
      run_once: true # Ensures gzping happens only once on the control node

    - name: Create a gz archive of the final data local folder
      community.general.archive:
        path: "{{ vector_db_dir }}"
        dest: "{{ vector_db_archive_path }}"
        format: gz
      delegate_to: localhost
      run_once: true # Ensures gzping happens only once on the control node

    - name: Create a gz archive of the models dir local folder
      community.general.archive:
        path: "{{ models_dir }}"
        dest: "{{ models_archive_path }}"
        format: gz
      delegate_to: localhost
      run_once: true # Ensures gzping happens only once on the control node

    - name: Ensure the remote destination directory exists
      ansible.builtin.file:
        path: "{{ remote_dest_dir }}"
        state: directory
        mode: '0755'

    - name: Copy and unarchive the gz file on the remote host
      ansible.builtin.unarchive:
        src: "{{ final_data_archive_path }}"
        dest: "{{ remote_dest_dir }}"
        # By default, copy=yes (or implicit with src/dest) so Ansible copies 
        # the archive from the local host to the remote host first, then unzips it.
        remote_src: false # Explicitly set to indicate source is on the control host
        # Optional: Use extra_opts to strip the top-level directory if needed
        # extra_opts: [--strip-components=1] 
